<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Upload CSV to Redis TimeSeries</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 50px auto;
      padding: 20px;
    }
    .upload-form {
      border: 2px dashed #ccc;
      padding: 40px;
      text-align: center;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    .upload-form:hover {
      border-color: #999;
    }
    input[type="file"] {
      margin: 20px 0;
      padding: 10px;
    }
    button {
      background-color: #007bff;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background-color: #0056b3;
    }
    button:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }
    
    /* Button styles for RAW/AGR */
    .data-buttons {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
    }
    .data-buttons button {
      background-color: #17a2b8;
    }
    .data-buttons button:hover {
      background-color: #138496;
    }
    .data-buttons button.active {
      background-color: #28a745;
    }
    .data-buttons button.active:hover {
      background-color: #218838;
    }
    
    #result {
      margin-top: 20px;
      padding: 15px;
      border-radius: 5px;
      display: none;
    }
    .success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .loading {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Table Styles */
    .table-container {
      overflow-x: auto;
      margin-top: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background-color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }
    th {
      background-color: #f8f9fa;
      font-weight: bold;
      color: #495057;
    }
    tr:nth-child(even) {
      background-color: #f8f9fa;
    }
    tr:hover {
      background-color: #e9ecef;
    }
    .status-success {
      color: #155724;
      font-weight: bold;
    }
    .status-error {
      color: #721c24;
      font-weight: bold;
    }
    .timestamp {
      font-family: 'Courier New', monospace;
      font-size: 14px;
    }
    .summary {
      background-color: #e9ecef;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 15px;
    }
    .summary h4 {
      margin: 0 0 10px 0;
      color: #495057;
    }
    
    /* Pagination Styles */
    .pagination-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 20px 0;
      flex-wrap: wrap;
      gap: 10px;
    }
    .pagination-info {
      color: #495057;
      font-size: 14px;
    }
    .pagination-controls {
      display: flex;
      gap: 5px;
      align-items: center;
      flex-wrap: wrap;
    }
    .pagination-controls select {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: white;
    }
    .pagination-controls button {
      padding: 8px 12px;
      font-size: 14px;
      min-width: 40px;
    }
    .pagination-controls .page-btn {
      background-color: #f8f9fa;
      color: #495057;
      border: 1px solid #ddd;
    }
    .pagination-controls .page-btn:hover {
      background-color: #e9ecef;
    }
    .pagination-controls .page-btn.active {
      background-color: #007bff;
      color: white;
      border-color: #007bff;
    }
    .pagination-controls .nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Search Styles */
    .search-container {
      margin-bottom: 15px;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .search-container input {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      min-width: 200px;
      flex: 1;
    }
    .search-container button {
      padding: 10px 15px;
      background-color: #28a745;
    }
    .search-container button:hover {
      background-color: #218838;
    }
  </style>
</head>
<body>
  <div class="data-buttons">
    <button id="rawButton">RAW Data</button>
    <button id="agrButton">Aggregated Data</button>
  </div>

  <h1>Upload CSV to Redis TimeSeries</h1>
  
  <div class="upload-form">
    <h3>Select CSV File</h3>
    <p>Choose a CSV file containing temperature data</p>
    
    <form id="uploadForm" enctype="multipart/form-data">
      <input type="file" name="csv_file" accept=".csv" required />
      <br>
      <button type="submit" id="submitBtn">
        <span id="btnText">Upload</span>
      </button>
    </form>
  </div>
  
  <div id="result"></div>

  <script>
    // Global variables for pagination
    let currentData = [];
    let filteredData = [];
    let currentPage = 1;
    let itemsPerPage = 10;
    let currentDataType = 'raw'; // Track current data type

    // Function to filter data based on search
    function filterData(searchTerm) {
      if (!searchTerm) {
        filteredData = [...currentData];
        return;
      }
      
      filteredData = currentData.filter(row => {
        return Object.values(row).some(value => 
          String(value).toLowerCase().includes(searchTerm.toLowerCase())
        );
      });
    }

    // Function to get paginated data
    function getPaginatedData() {
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      return filteredData.slice(startIndex, endIndex);
    }

    // Function to create pagination controls
    function createPaginationControls() {
      const totalItems = filteredData.length;
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      
      if (totalPages <= 1) return '';
      
      const startItem = totalItems > 0 ? (currentPage - 1) * itemsPerPage + 1 : 0;
      const endItem = Math.min(currentPage * itemsPerPage, totalItems);
      
      let html = `
        <div class="pagination-container">
          <div class="pagination-info">
            Showing ${startItem}-${endItem} of ${totalItems} entries
          </div>
          <div class="pagination-controls">
            <label>Show 
              <select id="itemsPerPageSelect">
                <option value="10" ${itemsPerPage === 10 ? 'selected' : ''}>10</option>
                <option value="25" ${itemsPerPage === 25 ? 'selected' : ''}>25</option>
                <option value="50" ${itemsPerPage === 50 ? 'selected' : ''}>50</option>
                <option value="100" ${itemsPerPage === 100 ? 'selected' : ''}>100</option>
              </select>
              entries
            </label>
            
            <button class="nav-btn" onclick="goToPage(1)" ${currentPage === 1 ? 'disabled' : ''}>First</button>
            <button class="nav-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Prev</button>
      `;
      
      // Page numbers
      const maxVisiblePages = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
      
      if (endPage - startPage < maxVisiblePages - 1) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }
      
      if (startPage > 1) {
        html += `<span>...</span>`;
      }
      
      for (let i = startPage; i <= endPage; i++) {
        html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
      }
      
      if (endPage < totalPages) {
        html += `<span>...</span>`;
      }
      
      html += `
            <button class="nav-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>
            <button class="nav-btn" onclick="goToPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>Last</button>
          </div>
        </div>
      `;
      
      return html;
    }

    // Function to create search controls
    function createSearchControls() {
      return `
        <div class="search-container">
          <input type="text" id="searchInput" placeholder="Search in all columns..." />
          <button onclick="performSearch()">Search</button>
          <button onclick="clearSearch()" style="background-color: #6c757d;">Clear</button>
        </div>
      `;
    }

    // Function to create table from JSON data with pagination
    function createTable(data, dataType = 'raw') {
      if (!Array.isArray(data) || data.length === 0) {
        return '<p>No data to display</p>';
      }
      
      // Store data globally
      currentData = data;
      filteredData = [...data];
      currentPage = 1;
      currentDataType = dataType;
      
      let html = '';
      
      // Create summary
      html += `<div class="summary">
        <h4>Data Summary</h4>
        <p><strong>Data Type:</strong> ${dataType === 'raw' ? 'Raw Data' : 'Aggregated Data'}</p>
        <p><strong>Total Records:</strong> ${data.length}</p>
        <p><strong>Status:</strong> <span class="status-success">Success</span></p>
      </div>`;
      
      // Add search controls
      html += createSearchControls();
      
      // Add pagination controls (top)
      html += createPaginationControls();
      
      // Create table
      html += '<div class="table-container"><table id="dataTable">';
      
      // Table headers
      const headers = Object.keys(data[0]);
      html += '<thead><tr>';
      headers.forEach(header => {
        html += `<th>${header.charAt(0).toUpperCase() + header.slice(1)}</th>`;
      });
      html += '</tr></thead>';
      
      // Table body with paginated data
      html += '<tbody>';
      const paginatedData = getPaginatedData();
      paginatedData.forEach(row => {
        html += '<tr>';
        headers.forEach(header => {
          let value = row[header];
          if (header.toLowerCase().includes('timestamp') || header.toLowerCase().includes('time')) {
            html += `<td class="timestamp">${value || ''}</td>`;
          } else {
            html += `<td>${value || ''}</td>`;
          }
        });
        html += '</tr>';
      });
      html += '</tbody></table></div>';
      
      // Add pagination controls (bottom)
      html += createPaginationControls();
      
      return html;
    }

    // Function to update table display
    function updateTable() {
      const tableBody = document.querySelector('#dataTable tbody');
      const headers = Object.keys(currentData[0]);
      
      if (!tableBody) return;
      
      // Update table body
      const paginatedData = getPaginatedData();
      tableBody.innerHTML = '';
      paginatedData.forEach(row => {
        let rowHtml = '<tr>';
        headers.forEach(header => {
          let value = row[header];
          if (header.toLowerCase().includes('timestamp') || header.toLowerCase().includes('time')) {
            rowHtml += `<td class="timestamp">${value || ''}</td>`;
          } else {
            rowHtml += `<td>${value || ''}</td>`;
          }
        });
        rowHtml += '</tr>';
        tableBody.innerHTML += rowHtml;
      });
      
      // Update pagination controls
      const paginationContainers = document.querySelectorAll('.pagination-container');
      const newPaginationHTML = createPaginationControls();
      
      paginationContainers.forEach(container => {
        container.outerHTML = newPaginationHTML;
      });
      
      // Re-attach event listener for items per page
      const itemsSelect = document.getElementById('itemsPerPageSelect');
      if (itemsSelect) {
        itemsSelect.addEventListener('change', function() {
          itemsPerPage = parseInt(this.value);
          currentPage = 1;
          updateTable();
        });
      }
    }

    // Navigation functions
    function goToPage(page) {
      const totalPages = Math.ceil(filteredData.length / itemsPerPage);
      if (page >= 1 && page <= totalPages) {
        currentPage = page;
        updateTable();
      }
    }

    // Search functions
    function performSearch() {
      const searchTerm = document.getElementById('searchInput').value;
      filterData(searchTerm);
      currentPage = 1;
      updateTable();
    }

    function clearSearch() {
      document.getElementById('searchInput').value = '';
      filterData('');
      currentPage = 1;
      updateTable();
    }

    // Function to update button states
    function updateButtonStates(activeButton) {
      const rawBtn = document.getElementById('rawButton');
      const agrBtn = document.getElementById('agrButton');
      
      rawBtn.classList.remove('active');
      agrBtn.classList.remove('active');
      
      if (activeButton) {
        activeButton.classList.add('active');
      }
    }

    // Function to load data based on type
    async function loadData(dataType) {
      const resultDiv = document.getElementById('result');
      
      // Show loading
      resultDiv.className = 'loading';
      resultDiv.innerHTML = `
        <div class="summary">
          <h4>Loading</h4>
          <p>Fetching ${dataType === 'raw' ? 'raw' : 'aggregated'} data...</p>
        </div>
      `;
      resultDiv.style.display = 'block';
      
      try {
        const url = dataType === 'raw' ? 'redis-timeseries.php?raw=true' : 'redis-timeseries.php?agr=true';
        const response = await fetch(url);
        const responseText = await response.text();
        
        if (response.ok) {
          try {
            const data = JSON.parse(responseText);
            resultDiv.className = 'success';
            
            if (Array.isArray(data) && data.length > 0) {
              resultDiv.innerHTML = createTable(data, dataType);
              
              // Add search event listener
              setTimeout(() => {
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                  searchInput.addEventListener('keyup', function(e) {
                    if (e.key === 'Enter') {
                      performSearch();
                    }
                  });
                }
              }, 100);
            } else {
              resultDiv.innerHTML = `
                <div class="summary">
                  <h4>No Data</h4>
                  <p>No ${dataType === 'raw' ? 'raw' : 'aggregated'} data found. Please upload a CSV file first.</p>
                </div>
              `;
            }
          } catch (error) {
            resultDiv.className = 'error';
            resultDiv.innerHTML = `
              <div class="summary">
                <h4>Parse Error</h4>
                <p><span class="status-error">Failed to parse response</span></p>
              </div>
              <div class="table-container">
                <table>
                  <thead><tr><th>Raw Response</th></tr></thead>
                  <tbody><tr><td>${responseText}</td></tr></tbody>
                </table>
              </div>
            `;
          }
        } else {
          resultDiv.className = 'error';
          resultDiv.innerHTML = `
            <div class="summary">
              <h4>Error</h4>
              <p><span class="status-error">Failed to load data</span></p>
            </div>
            <div class="table-container">
              <table>
                <thead><tr><th>Error Details</th></tr></thead>
                <tbody><tr><td class="status-error">${responseText}</td></tr></tbody>
              </table>
            </div>
          `;
        }
      } catch (error) {
        resultDiv.className = 'error';
        resultDiv.innerHTML = `
          <div class="summary">
            <h4>Network Error</h4>
            <p><span class="status-error">Connection failed</span></p>
          </div>
          <div class="table-container">
            <table>
              <thead><tr><th>Error Details</th></tr></thead>
              <tbody><tr><td class="status-error">${error.message}</td></tr></tbody>
            </table>
          </div>
        `;
      }
    }

    // Function to handle non-array data
    function createNonArrayTable(data) {
      let html = '';
      
      if (typeof data === 'object' && data !== null) {
        html += `<div class="summary">
          <h4>Response Details</h4>
        </div>`;
        
        html += '<div class="table-container"><table>';
        html += '<thead><tr><th>Property</th><th>Value</th></tr></thead>';
        html += '<tbody>';
        
        Object.entries(data).forEach(([key, value]) => {
          html += '<tr>';
          html += `<td><strong>${key.charAt(0).toUpperCase() + key.slice(1)}</strong></td>`;
          
          if (typeof value === 'object' && value !== null) {
            html += `<td><pre>${JSON.stringify(value, null, 2)}</pre></td>`;
          } else {
            html += `<td>${value}</td>`;
          }
          html += '</tr>';
        });
        
        html += '</tbody></table></div>';
      } else {
        html += `<div class="summary">
          <h4>Response</h4>
          <p>${data}</p>
        </div>`;
      }
      
      return html;
    }

    document.addEventListener('DOMContentLoaded', async function () {
      // Load initial raw data
      updateButtonStates(document.getElementById('rawButton'));
      await loadData('raw');
    });

    document.getElementById('uploadForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submitBtn');
      const btnText = document.getElementById('btnText');
      const resultDiv = document.getElementById('result');
      
      submitBtn.disabled = true;
      btnText.innerHTML = '<span class="spinner"></span>Uploading...';
      
      resultDiv.className = 'loading';
      resultDiv.innerHTML = `
        <div class="summary">
          <h4>Processing</h4>
          <p>Uploading and processing CSV file...</p>
        </div>
      `;
      resultDiv.style.display = 'block';
      
      const formData = new FormData(this);
      
      try {
        const response = await fetch('redis-timeseries.php', {
          method: 'POST',
          body: formData
        });
        
        const responseText = await response.text();
        console.log('Response Text:', responseText);
        
        if (response.ok) {
          try {
            const data = JSON.parse(responseText);
            resultDiv.className = 'success';
            if (Array.isArray(data) && data.length > 0) {
              resultDiv.innerHTML = createTable(data, 'raw');
              updateButtonStates(document.getElementById('rawButton'));
              
              // Add search event listener
              setTimeout(() => {
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                  searchInput.addEventListener('keyup', function(e) {
                    if (e.key === 'Enter') {
                      performSearch();
                    }
                  });
                }
              }, 100);
            } else {
              resultDiv.innerHTML = createNonArrayTable(data);
            }
          } catch (error) {
            resultDiv.className = 'success';
            resultDiv.innerHTML = `
              <div class="summary">
                <h4>Upload Complete</h4>
                <p><span class="status-success">Success</span></p>
              </div>
              <div class="table-container">
                <table>
                  <thead><tr><th>Server Response</th></tr></thead>
                  <tbody><tr><td>${responseText}</td></tr></tbody>
                </table>
              </div>
            `;
          }
        } else {
          resultDiv.className = 'error';
          resultDiv.innerHTML = `
            <div class="summary">
              <h4>Upload Failed</h4>
              <p><span class="status-error">Error</span></p>
            </div>
            <div class="table-container">
              <table>
                <thead><tr><th>Error Details</th></tr></thead>
                <tbody><tr><td class="status-error">${responseText}</td></tr></tbody>
              </table>
            </div>
          `;
        }
        
      } catch (error) {
        resultDiv.className = 'error';
        resultDiv.innerHTML = `
          <div class="summary">
            <h4>Upload Failed</h4>
            <p><span class="status-error">Network Error</span></p>
          </div>
          <div class="table-container">
            <table>
              <thead><tr><th>Error Details</th></tr></thead>
              <tbody><tr><td class="status-error">${error.message}</td></tr></tbody>
            </table>
          </div>
        `;
      } finally {
        submitBtn.disabled = false;
        btnText.innerHTML = 'Upload';
      }
    });

    document.querySelector('input[type="file"]').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const resultDiv = document.getElementById('result');
        resultDiv.style.display = 'none';
      }
    });

    // Fixed button event listeners - use AJAX instead of window.location
    document.getElementById('rawButton').addEventListener('click', async function() {
      updateButtonStates(this);
      await loadData('raw');
    });

    document.getElementById('agrButton').addEventListener('click', async function() {
      updateButtonStates(this);
      await loadData('agr');
    });

  </script>
</body>
</html>